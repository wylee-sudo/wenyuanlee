<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NCS ↔ RGB 工具｜Color & Design Research Lab</title>
<style>
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;background:#808080;color:#111}
  header,footer{padding:16px;text-align:center;color:#eee}
  header h1{margin:0 0 6px;font-size:clamp(18px,4vw,28px)}
  .container{max-width:1000px;margin:0 auto;padding:16px}
  .card{background:#f4f4f4;border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.15);padding:16px;margin-bottom:20px}
  label{display:block;font-weight:600;margin:8px 0 6px}
  select,input,button{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #ccc;font-size:16px}
  button{background:#111;color:#fff;cursor:pointer;margin-top:8px}
  .swatch{width:100%;height:80px;border-radius:12px;border:1px solid #ddd;margin-top:10px}
  canvas{background:#fff;border:1px solid #ccc;border-radius:8px;width:100%;max-width:400px;height:auto}
  .viz{display:flex;flex-wrap:wrap;gap:20px;justify-content:center;margin-top:20px}
</style>
</head>
<body>
<header>
  <h1>NCS ↔ RGB 轉換工具</h1>
  <p>輸入 NCS 或 RGB，顯示色塊與對應數值，並在 NCS 色相環 + WSC 三角中標示位置</p>
</header>
<div class="container">
  <div class="card">
    <h2>輸入 NCS 色碼</h2>
    <label>黑度 (S)</label>
    <select id="sSelect"></select>
    <label>彩度 (C)</label>
    <select id="cSelect"></select>
    <label>色相 (Hue)</label>
    <select id="hueSelect"></select>
    <div class="swatch" id="swatchA"></div>
    <div id="rgbA"></div>
    <div id="hexA"></div>
  </div>
  <div class="card">
    <h2>輸入 RGB</h2>
    <label>R</label><input id="rInput" type="number" min="0" max="255" />
    <label>G</label><input id="gInput" type="number" min="0" max="255" />
    <label>B</label><input id="bInput" type="number" min="0" max="255" />
    <button onclick="findByRGB()">查詢</button>
    <div id="ncsB"></div>
    <div class="swatch" id="swatchB"></div>
    <div id="rgbB"></div>
    <div id="hexB"></div>
  </div>
  <div class="viz">
    <div>
      <canvas id="hueCanvas" width="400" height="400"></canvas>
    </div>
    <div>
      <canvas id="triCanvas" width="400" height="400"></canvas>
    </div>
  </div>
</div>
<footer>Developed by <a href="index.html">Color & Design Research Lab</a></footer>
<script>
// 以 fetch('./ncs-data.json') 載入資料（放同層）
let DATA=[], A=null, B=null; // A=下拉式 NCS；B=RGB 近似

const sSel=document.getElementById('sSel');
const cSel=document.getElementById('cSel');
const hSel=document.getElementById('hSel');
const swatchA=document.getElementById('swatchA');
const infoA=document.getElementById('infoA');
const swatchB=document.getElementById('swatchB');
const infoB=document.getElementById('infoB');

const hueCanvas=document.getElementById('hueCanvas');
const triCanvas=document.getElementById('triCanvas');
const hctx=hueCanvas.getContext('2d');
const tctx=triCanvas.getContext('2d');

function loadData(){
  fetch('./ncs-data.json')
    .then(r=>r.json())
    .then(arr=>{ DATA = arr.map(normalizeRec); fillOptionsFromData(); updateFromNCS(); redraw(); })
    .catch(err=>{ console.error(err); infoA.textContent='載入 ncs-data.json 失敗'; });
}

function normalizeRec(d){
  const out={};
  out.ncs=String(d['NCS code']||'').trim();
  out.S=Number(d.S)||0; out.C=Number(d.C)||0; out.W=Number(d.W)||0;
  const rawHue = d.hue? String(d.hue): inferHue(out.ncs);
  out.hue = rawHue ? rawHue.toUpperCase() : 'N';
  let hex = String(d['Hex code']||'').trim(); if(hex && hex.charAt(0)!='#') hex='#'+hex; out.hex=hex;
  out.R=Number(d.R); out.G=Number(d.G); out.B=Number(d.B);
  if(!(out.R>=0 && out.G>=0 && out.B>=0) && out.hex && out.hex.length===7){
    out.R=parseInt(out.hex.slice(1,3),16);
    out.G=parseInt(out.hex.slice(3,5),16);
    out.B=parseInt(out.hex.slice(5,7),16);
  }
  return out;
}

function inferHue(ncs){
  const i = ncs.indexOf('-');
  if(i>=0){ return ncs.slice(i+1).toUpperCase(); }
  return 'N';
}

// ===== 視覺化（參考圖重繪） =====
const BASE_ANGLE={Y:0,R:90,B:180,G:270};
function hueToAngle(h){
  if(!h || h==='N') return null;
  if(h.length===1) return BASE_ANGLE[h]||0; // Y/R/B/G
  const a=h.charAt(0), b=h.charAt(h.length-1);
  const num=parseInt(h.slice(1, -1),10);
  const A=BASE_ANGLE[a]||0, B=BASE_ANGLE[b]||0;
  const p=Math.max(0, Math.min(100, isNaN(num)?0:num))/100;
  const diff=(B - A + 360) % 360;
  return (A + diff*p) % 360;
}

function drawHueBase(){
  const w=hueCanvas.width, h=hueCanvas.height; hctx.clearRect(0,0,w,h);
  const cx=w/2, cy=h/2, R=Math.min(w,h)/2-28;
  // 外圈
  hctx.beginPath(); hctx.arc(cx,cy,R,0,Math.PI*2); hctx.strokeStyle='#000'; hctx.lineWidth=3; hctx.stroke();
  // 主軸 Y,R,B,G
  [0,90,180,270].forEach(a=>{ const rad=(a-90)*Math.PI/180; hctx.beginPath(); hctx.moveTo(cx,cy); hctx.lineTo(cx+R*Math.cos(rad), cy+R*Math.sin(rad)); hctx.strokeStyle='#000'; hctx.lineWidth=1.2; hctx.stroke(); });
  // 標籤
  [['Y',0],['R',90],['B',180],['G',270]].forEach(function(item){ var txt=item[0], ang=item[1]; var rad=(ang-90)*Math.PI/180; var x=cx+(R+14)*Math.cos(rad), y=cy+(R+14)*Math.sin(rad); hctx.fillStyle='#000'; hctx.font='16px system-ui'; hctx.textAlign='center'; hctx.textBaseline='middle'; hctx.fillText(txt,x,y); });
}
function drawHueMarker(angle,color){
  const R=Math.min(hueCanvas.width,hueCanvas.height)/2-36; const cx=hueCanvas.width/2, cy=hueCanvas.height/2;
  if(angle==null){ hctx.beginPath(); hctx.arc(cx,cy,7,0,Math.PI*2); hctx.fillStyle=color; hctx.fill(); return; }
  const rad=(angle-90)*Math.PI/180; const x=cx+R*Math.cos(rad), y=cy+R*Math.sin(rad);
  hctx.beginPath(); hctx.arc(x,y,7,0,Math.PI*2); hctx.fillStyle=color; hctx.fill();
}

function drawTriBase(){
  const w=triCanvas.width, h=triCanvas.height; tctx.clearRect(0,0,w,h);
  const pad=28; const Ax=w/2, Ay=pad, Bx=pad, By=h-pad, Cx=w-pad, Cy=h-pad;
  // 粗邊
  tctx.lineWidth=4; tctx.strokeStyle='#000'; tctx.beginPath(); tctx.moveTo(Bx,By); tctx.lineTo(Ax,Ay); tctx.lineTo(Cx,Cy); tctx.lineTo(Bx,By); tctx.stroke();
  // 輔助線（每 20）
  tctx.setLineDash([6,6]); tctx.lineWidth=1; tctx.strokeStyle='#000';
  for(var v=20; v<100; v+=20){ var p=v/100; var Px=(1-p)*Bx+p*Cx, Py=(1-p)*By+p*Cy; tctx.beginPath(); tctx.moveTo(Px,Py); tctx.lineTo((1-p)*Bx+p*Ax, (1-p)*By+p*Ay); tctx.stroke(); }
  tctx.setLineDash([]);
  // 頂點標籤
  tctx.font='16px system-ui'; tctx.fillStyle='#000'; tctx.textAlign='center'; tctx.fillText('W',Ax,Ay-14); tctx.textAlign='right'; tctx.fillText('S',Bx-10,By+2); tctx.textAlign='left'; tctx.fillText('C',Cx+10,Cy+2);
}
function drawTriMarker(W,S,C,color){
  const w=triCanvas.width, h=triCanvas.height; const pad=28; const Ax=w/2, Ay=pad, Bx=pad, By=h-pad, Cx=w-pad, Cy=h-pad;
  const sum=W+S+C; if(!(sum>0)) return; const w1=W/sum, s1=S/sum, c1=C/sum;
  const x=w1*Ax + s1*Bx + c1*Cx; const y=w1*Ay + s1*By + c1*Cy;
  tctx.beginPath(); tctx.arc(x,y,7,0,Math.PI*2); tctx.fillStyle=color; tctx.fill();
}

function redraw(){ drawHueBase(); drawTriBase(); if(A){ drawHueMarker(hueToAngle(A.hue),'#111'); drawTriMarker(A.W,A.S,A.C,'#111'); } if(B){ drawHueMarker(hueToAngle(B.hue),'#c20000'); drawTriMarker(B.W,B.S,B.C,'#c20000'); } }

// ===== 下拉選單 =====
function fillOptionsFromData(){
  var Sset=new Set(), Cset=new Set(), Hset=new Set();
  DATA.forEach(function(d){ if(!isNaN(d.S)) Sset.add(d.S); if(!isNaN(d.C)) Cset.add(d.C); if(d.hue) Hset.add(d.hue); });
  var S=[].concat(Array.from(Sset)).sort(function(a,b){return a-b});
  var C=[].concat(Array.from(Cset)).sort(function(a,b){return a-b});
  var order=['N','Y','Y10R','Y20R','Y30R','Y40R','Y50R','Y60R','Y70R','Y80R','Y90R','R','R10B','R20B','R30B','R40B','R50B','R60B','R70B','R80B','R90B','B','B10G','B20G','B30G','B40G','B50G','B60G','B70G','B80G','B90G','G','G10Y','G20Y','G30Y','G40Y','G50Y','G60Y','G70Y','G80Y','G90Y'];
  var H=[].concat(Array.from(Hset)).sort(function(a,b){ return order.indexOf(a)-order.indexOf(b); });
  sSel.innerHTML=''; cSel.innerHTML=''; hSel.innerHTML='';
  S.forEach(function(v){ var o=document.createElement('option'); o.value=v; o.textContent=v; sSel.appendChild(o); });
  C.forEach(function(v){ var o=document.createElement('option'); o.value=v; o.textContent=v; cSel.appendChild(o); });
  H.forEach(function(v){ var o=document.createElement('option'); o.value=v; o.textContent=v; hSel.appendChild(o); });
  sSel.addEventListener('change', updateFromNCS); cSel.addEventListener('change', updateFromNCS); hSel.addEventListener('change', updateFromNCS);
}

function updateFromNCS(){
  var S=Number(sSel.value), C=Number(cSel.value), hue=(hSel.value||'').toUpperCase();
  var W=Math.max(0,100-S-C);
  var rec = DATA.find(function(d){ return d.S===S && d.C===C && d.hue===hue; });
  if(!rec){ var cand = DATA.filter(function(d){ return d.S===S && d.C===C && (d.ncs.toUpperCase().indexOf(hue)>=0 || d.hue===hue); }); rec = cand[0]; }
  A = {W:W,S:S,C:C,hue:hue};
  if(rec){ swatchA.style.background=rec.hex; infoA.textContent=rec.ncs+"  |  RGB=("+rec.R+","+rec.G+","+rec.B+")  HEX="+rec.hex; }
  else { swatchA.style.background='#ffffff'; infoA.textContent='找不到完全對應色（資料無此組合）。'; }
  redraw();
}

// ===== RGB → 最近 NCS =====
function findNearestByRGB(){
  var R=Number(document.getElementById('rIn').value), G=Number(document.getElementById('gIn').value), Bv=Number(document.getElementById('bIn').value);
  if(!(R>=0&&G>=0&&Bv>=0)) { infoB.textContent='請輸入 R/G/B (0–255)'; return; }
  var best=null, bestD=Infinity;
  DATA.forEach(function(d){ var dd=(d.R-R)*(d.R-R)+(d.G-G)*(d.G-G)+(d.B-Bv)*(d.B-Bv); if(dd<bestD){bestD=dd; best=d;} });
  if(best){ B={W:best.W,S:best.S,C:best.C,hue:best.hue}; swatchB.style.background=best.hex; infoB.textContent='最近 NCS：'+best.ncs+' | RGB=('+best.R+','+best.G+','+best.B+') HEX='+best.hex+' | W='+best.W+' S='+best.S+' C='+best.C+' hue='+best.hue; }
  else { infoB.textContent='資料為空'; }
  redraw();
}

document.getElementById('btnFind').addEventListener('click', findNearestByRGB);

function redraw(){ drawHueBase(); drawTriBase(); if(A){ drawHueMarker(hueToAngle(A.hue),'#111'); drawTriMarker(A.W,A.S,A.C,'#111'); } if(B){ drawHueMarker(hueToAngle(B.hue),'#c20000'); drawTriMarker(B.W,B.S,B.C,'#c20000'); } }

// 初始底圖與資料載入
redraw();
loadData();
</script>
</body>
</html>
